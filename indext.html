<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Association Arganiers</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    .main-container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .content-area {
      flex: 1;
      overflow-y: auto;
    }
    
    .stat-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .nav-item {
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .nav-item:hover {
      transform: translateX(4px);
    }
    
    .nav-item.active {
      font-weight: 600;
    }
    
    .btn-primary {
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .table-row {
      transition: background-color 0.2s;
    }
    
    .table-row:hover {
      background-color: rgba(0,0,0,0.02);
    }
    
    .loading-spinner {
      border: 3px solid rgba(0,0,0,0.1);
      border-top-color: #2563eb;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      animation: scaleIn 0.2s;
    }
    
    @keyframes scaleIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="main-container"><!-- Navigation latÃ©rale -->
   <div style="display: flex; height: 100%;">
    <nav id="sidebar" style="width: 260px; padding: 24px; border-right: 1px solid #e5e7eb;">
     <div style="margin-bottom: 32px;">
      <img src="logo.jpg" alt="" style="width: 100px;">
      <p id="welcome-message" style="font-size: 13px; color: #6b7280; margin-top: 4px;">Bienvenue dans votre espace de gestion</p>
     </div>
     <div style="display: flex; flex-direction: column; gap: 8px;">
      <div class="nav-item active" data-page="dashboard" style="padding: 12px 16px; border-radius: 8px; color: #1f2937;"><span style="font-size: 15px;">ðŸ“Š Tableau de bord</span>
      </div>
      <div class="nav-item" data-page="achats" style="padding: 12px 16px; border-radius: 8px; color: #1f2937;"><span style="font-size: 15px;">ðŸ›’ Achats matiÃ¨res premiÃ¨res</span>
      </div>
      <div class="nav-item" data-page="ventes" style="padding: 12px 16px; border-radius: 8px; color: #1f2937;"><span style="font-size: 15px;">ðŸ’° Ventes extraits</span>
      </div>
      <div class="nav-item" data-page="stock" style="padding: 12px 16px; border-radius: 8px; color: #1f2937;"><span style="font-size: 15px;">ðŸ“¦ Gestion du stock</span>
      </div>
      <div class="nav-item" data-page="fournisseurs" style="padding: 12px 16px; border-radius: 8px; color: #1f2937;"><span style="font-size: 15px;">ðŸ‘¥ Fournisseurs</span>
      </div>
      <div class="nav-item" data-page="rapports" style="padding: 12px 16px; border-radius: 8px; color: #1f2937;"><span style="font-size: 15px;">ðŸ“ˆ Rapports financiers</span>
      </div>
     </div>
    </nav><!-- Zone de contenu -->
    <div class="content-area" style="flex: 1;"><!-- Page Tableau de bord -->
     <div id="page-dashboard" class="page-content" style="padding: 32px;">
      <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 24px; color: #1f2937;">Tableau de bord</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
       <div class="stat-card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
         Total Achats
        </div>
        <div id="stat-achats" style="font-size: 32px; font-weight: 700; color: #2563eb;">
         0 DH
        </div>
       </div>
       <div class="stat-card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
         Total Ventes
        </div>
        <div id="stat-ventes" style="font-size: 32px; font-weight: 700; color: #10b981;">
         0 DH
        </div>
       </div>
       <div class="stat-card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
         BÃ©nÃ©fice Net
        </div>
        <div id="stat-benefice" style="font-size: 32px; font-weight: 700; color: #8b5cf6;">
         0 DH
        </div>
       </div>
       <div class="stat-card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
         Transactions
        </div>
        <div id="stat-transactions" style="font-size: 32px; font-weight: 700; color: #f59e0b;">
         0
        </div>
       </div>
      </div>
      <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
       <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">ActivitÃ©s rÃ©centes</h3>
       <div id="recent-activities" style="display: flex; flex-direction: column; gap: 12px;">
        <div style="text-align: center; padding: 40px; color: #9ca3af;">
         Aucune activitÃ© rÃ©cente
        </div>
       </div>
      </div>
     </div><!-- Page Achats -->
     <div id="page-achats" class="page-content" style="display: none; padding: 32px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
       <h2 style="font-size: 28px; font-weight: 700; margin: 0; color: #1f2937;">Achats matiÃ¨res premiÃ¨res</h2><button id="btn-add-achat" class="btn-primary" style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-size: 15px; font-weight: 600; cursor: pointer;"> + Nouvel achat </button>
      </div>
      <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
       <div id="achats-list" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
         <thead>
          <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
           <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">Date</th>
           <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">Fournisseur</th>
           <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">Produit</th>
           <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">QuantitÃ©</th>
           <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">Prix unitaire</th>
           <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">Total</th>
           <th style="padding: 16px; text-align: center; font-size: 13px; font-weight: 600; color: #6b7280;">Statut</th>
           <th style="padding: 16px; text-align: center; font-size: 13px; font-weight: 600; color: #6b7280;">Actions</th>
          </tr>
         </thead>
         <tbody id="achats-tbody">
          <tr>
           <td colspan="8" style="padding: 40px; text-align: center; color: #9ca3af;">Aucun achat enregistrÃ©</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- Page Ventes -->
     <div id="page-ventes" class="page-content" style="display: none; padding: 32px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
       <h2 style="font-size: 28px; font-weight: 700; margin: 0; color: #1f2937;">Ventes extraits d'argan</h2><button id="btn-add-vente" class="btn-primary" style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-size: 15px; font-weight: 600; cursor: pointer;"> + Nouvelle vente </button>
      </div>
      <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
       <div id="ventes-list" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
         <thead>
          <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
           <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">Date</th>
           <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">Client</th>
           <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">Produit</th>
           <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">QuantitÃ©</th>
           <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">Prix unitaire</th>
           <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">Total</th>
           <th style="padding: 16px; text-align: center; font-size: 13px; font-weight: 600; color: #6b7280;">Statut</th>
           <th style="padding: 16px; text-align: center; font-size: 13px; font-weight: 600; color: #6b7280;">Actions</th>
          </tr>
         </thead>
         <tbody id="ventes-tbody">
          <tr>
           <td colspan="8" style="padding: 40px; text-align: center; color: #9ca3af;">Aucune vente enregistrÃ©e</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- Page Stock -->
     <div id="page-stock" class="page-content" style="display: none; padding: 32px;">
      <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 24px; color: #1f2937;">Gestion du stock</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
       <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">MatiÃ¨res premiÃ¨res</h3>
        <div id="stock-matieres" style="display: flex; flex-direction: column; gap: 12px;">
         <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; color: #374151;">Noix d'argan</span> <span style="font-size: 14px; font-weight: 600; color: #2563eb;">0 kg</span>
          </div>
         </div>
        </div>
       </div>
       <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">Extraits produits</h3>
        <div id="stock-extraits" style="display: flex; flex-direction: column; gap: 12px;">
         <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; color: #374151;">Huile d'argan</span> <span style="font-size: 14px; font-weight: 600; color: #10b981;">0 L</span>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Page Fournisseurs -->
     <div id="page-fournisseurs" class="page-content" style="display: none; padding: 32px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
       <h2 style="font-size: 28px; font-weight: 700; margin: 0; color: #1f2937;">Fournisseurs</h2><button id="btn-add-fournisseur" class="btn-primary" style="background: #8b5cf6; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-size: 15px; font-weight: 600; cursor: pointer;"> + Nouveau fournisseur </button>
      </div>
      <div id="fournisseurs-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
       <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; color: #9ca3af;">
        Aucun fournisseur enregistrÃ©
       </div>
      </div>
     </div><!-- Page Rapports -->
     <div id="page-rapports" class="page-content" style="display: none; padding: 32px;">
      <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 24px; color: #1f2937;">Rapports financiers</h2>
      <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
       <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">RÃ©sumÃ© mensuel</h3>
       <div id="rapport-mensuel" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div style="padding: 16px; background: #eff6ff; border-radius: 8px;">
         <div style="font-size: 13px; color: #1e40af; margin-bottom: 4px;">
          Achats du mois
         </div>
         <div style="font-size: 24px; font-weight: 700; color: #2563eb;">
          0 DH
         </div>
        </div>
        <div style="padding: 16px; background: #f0fdf4; border-radius: 8px;">
         <div style="font-size: 13px; color: #15803d; margin-bottom: 4px;">
          Ventes du mois
         </div>
         <div style="font-size: 24px; font-weight: 700; color: #10b981;">
          0 DH
         </div>
        </div>
        <div style="padding: 16px; background: #faf5ff; border-radius: 8px;">
         <div style="font-size: 13px; color: #6b21a8; margin-bottom: 4px;">
          Marge du mois
         </div>
         <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">
          0 DH
         </div>
        </div>
       </div>
      </div>
      <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
       <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">Historique des transactions</h3>
       <div id="rapport-historique" style="max-height: 400px; overflow-y: auto;">
        <div style="text-align: center; padding: 40px; color: #9ca3af;">
         Aucune transaction Ã  afficher
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Modal Formulaire -->
  <div id="modal-form" style="display: none;"></div>
  <script>
    const defaultConfig = {
      app_title: "Association des Arganiers",
      welcome_message: "Bienvenue dans votre espace de gestion",
      background_color: "#f3f4f6",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#2563eb",
      secondary_action_color: "#6b7280"
    };
    
    let allData = [];
    let currentRecordCount = 0;
    let isLoading = false;
    
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        currentRecordCount = data.length;
        updateDashboard();
        updateAchatsList();
        updateVentesList();
        updateStock();
        updateFournisseurs();
        updateRapports();
      }
    };
    
    async function initApp() {
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast("Erreur d'initialisation", "error");
        }
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const appTitle = document.getElementById('app-title');
            const welcomeMessage = document.getElementById('welcome-message');
            const sidebar = document.getElementById('sidebar');
            const body = document.body;
            
            if (appTitle) {
              appTitle.textContent = config.app_title || defaultConfig.app_title;
            }
            if (welcomeMessage) {
              welcomeMessage.textContent = config.welcome_message || defaultConfig.welcome_message;
            }
            
            const bgColor = config.background_color || defaultConfig.background_color;
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
            const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;
            
            body.style.backgroundColor = bgColor;
            
            if (sidebar) {
              sidebar.style.backgroundColor = surfaceColor;
            }
            
            document.querySelectorAll('h1, h2, h3, .nav-item').forEach(el => {
              el.style.color = textColor;
            });
            
            document.querySelectorAll('.btn-primary').forEach(btn => {
              if (btn.id === 'btn-add-achat' || btn.id === 'btn-add-fournisseur') {
                btn.style.backgroundColor = primaryColor;
              } else if (btn.id === 'btn-add-vente') {
                btn.style.backgroundColor = '#10b981';
              }
            });
            
            document.querySelectorAll('.stat-card').forEach(card => {
              card.style.backgroundColor = surfaceColor;
            });
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.background_color = value;
                    window.elementSdk.setConfig({ background_color: value });
                  }
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.surface_color = value;
                    window.elementSdk.setConfig({ surface_color: value });
                  }
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.primary_action_color = value;
                    window.elementSdk.setConfig({ primary_action_color: value });
                  }
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.secondary_action_color = value;
                    window.elementSdk.setConfig({ secondary_action_color: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }
      
      setupNavigation();
      setupEventListeners();
    }
    
    function setupNavigation() {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          navItems.forEach(nav => {
            nav.classList.remove('active');
            nav.style.backgroundColor = 'transparent';
          });
          item.classList.add('active');
          item.style.backgroundColor = '#f3f4f6';
          
          document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
          const targetPage = document.getElementById(`page-${page}`);
          if (targetPage) targetPage.style.display = 'block';
        });
      });
    }
    
    function setupEventListeners() {
      const btnAddAchat = document.getElementById('btn-add-achat');
      const btnAddVente = document.getElementById('btn-add-vente');
      const btnAddFournisseur = document.getElementById('btn-add-fournisseur');
      
      if (btnAddAchat) {
        btnAddAchat.addEventListener('click', () => openFormModal('achat'));
      }
      if (btnAddVente) {
        btnAddVente.addEventListener('click', () => openFormModal('vente'));
      }
      if (btnAddFournisseur) {
        btnAddFournisseur.addEventListener('click', () => openFormModal('fournisseur'));
      }
    }
    
    function openFormModal(type) {
      if (currentRecordCount >= 999) {
        showToast("Limite de 999 enregistrements atteinte. Veuillez supprimer des Ã©lÃ©ments.", "error");
        return;
      }
      
      const modal = document.getElementById('modal-form');
      let formTitle = '';
      let formFields = '';
      
      if (type === 'achat') {
        formTitle = 'Nouvel achat de matiÃ¨res premiÃ¨res';
        formFields = `
          <label for="form-fournisseur" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Fournisseur</label>
          <input type="text" id="form-fournisseur" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-produit" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Produit</label>
          <input type="text" id="form-produit" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-quantite" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">QuantitÃ© (kg)</label>
          <input type="number" id="form-quantite" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-prix" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Prix unitaire (DH)</label>
          <input type="number" id="form-prix" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-notes" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Notes</label>
          <textarea id="form-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px; resize: vertical;"></textarea>
        `;
      } else if (type === 'vente') {
        formTitle = 'Nouvelle vente d\'extraits';
        formFields = `
          <label for="form-fournisseur" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Client</label>
          <input type="text" id="form-fournisseur" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-produit" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Produit</label>
          <input type="text" id="form-produit" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-quantite" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">QuantitÃ© (L)</label>
          <input type="number" id="form-quantite" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-prix" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Prix unitaire (DH)</label>
          <input type="number" id="form-prix" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-notes" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Notes</label>
          <textarea id="form-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px; resize: vertical;"></textarea>
        `;
      } else if (type === 'fournisseur') {
        formTitle = 'Nouveau fournisseur';
        formFields = `
          <label for="form-fournisseur" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Nom du fournisseur</label>
          <input type="text" id="form-fournisseur" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-produit" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Produits fournis</label>
          <input type="text" id="form-produit" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px;">
          
          <label for="form-notes" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">Contact / Notes</label>
          <textarea id="form-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px; font-size: 14px; resize: vertical;"></textarea>
        `;
      }
      
      modal.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal-content" style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90%; overflow-y: auto;">
            <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 24px; color: #1f2937;">${formTitle}</h3>
            <form id="transaction-form">
              ${formFields}
              <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="submit" id="btn-submit" style="flex: 1; background: #2563eb; color: white; padding: 12px; border-radius: 8px; border: none; font-size: 15px; font-weight: 600; cursor: pointer;">
                  Enregistrer
                </button>
                <button type="button" id="btn-cancel" style="flex: 1; background: #e5e7eb; color: #374151; padding: 12px; border-radius: 8px; border: none; font-size: 15px; font-weight: 600; cursor: pointer;">
                  Annuler
                </button>
              </div>
              <div id="loading-indicator" style="display: none; text-align: center; margin-top: 16px;">
                <div class="loading-spinner" style="margin: 0 auto;"></div>
              </div>
            </form>
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
      
      const form = document.getElementById('transaction-form');
      const btnCancel = document.getElementById('btn-cancel');
      const btnSubmit = document.getElementById('btn-submit');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      btnCancel.addEventListener('click', () => {
        modal.style.display = 'none';
      });
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (isLoading) return;
        
        const fournisseur = document.getElementById('form-fournisseur').value;
        const produit = document.getElementById('form-produit').value;
        const notes = document.getElementById('form-notes').value;
        
        let quantite = 0;
        let prixUnitaire = 0;
        
        const quantiteInput = document.getElementById('form-quantite');
        const prixInput = document.getElementById('form-prix');
        
        if (quantiteInput) quantite = parseFloat(quantiteInput.value) || 0;
        if (prixInput) prixUnitaire = parseFloat(prixInput.value) || 0;
        
        const montantTotal = quantite * prixUnitaire;
        
        const newRecord = {
          id: Date.now().toString(),
          type: type,
          date: new Date().toISOString(),
          fournisseur: fournisseur,
          produit: produit,
          quantite: quantite,
          prix_unitaire: prixUnitaire,
          montant_total: montantTotal,
          statut: 'ComplÃ©tÃ©',
          notes: notes
        };
        
        isLoading = true;
        btnSubmit.disabled = true;
        btnCancel.disabled = true;
        loadingIndicator.style.display = 'block';
        
        if (window.dataSdk) {
          const result = await window.dataSdk.create(newRecord);
          
          isLoading = false;
          btnSubmit.disabled = false;
          btnCancel.disabled = false;
          loadingIndicator.style.display = 'none';
          
          if (result.isOk) {
            modal.style.display = 'none';
            showToast("Enregistrement ajoutÃ© avec succÃ¨s", "success");
          } else {
            showToast("Erreur lors de l'enregistrement", "error");
          }
        }
      });
    }
    
    function updateDashboard() {
      const achats = allData.filter(d => d.type === 'achat');
      const ventes = allData.filter(d => d.type === 'vente');
      
      const totalAchats = achats.reduce((sum, a) => sum + (a.montant_total || 0), 0);
      const totalVentes = ventes.reduce((sum, v) => sum + (v.montant_total || 0), 0);
      const benefice = totalVentes - totalAchats;
      
      const statAchats = document.getElementById('stat-achats');
      const statVentes = document.getElementById('stat-ventes');
      const statBenefice = document.getElementById('stat-benefice');
      const statTransactions = document.getElementById('stat-transactions');
      
      if (statAchats) statAchats.textContent = `${totalAchats.toFixed(2)} DH`;
      if (statVentes) statVentes.textContent = `${totalVentes.toFixed(2)} DH`;
      if (statBenefice) statBenefice.textContent = `${benefice.toFixed(2)} DH`;
      if (statTransactions) statTransactions.textContent = allData.length;
      
      const recentActivities = document.getElementById('recent-activities');
      if (recentActivities) {
        if (allData.length === 0) {
          recentActivities.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Aucune activitÃ© rÃ©cente</div>';
        } else {
          const recent = [...allData].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
          recentActivities.innerHTML = recent.map(item => {
            const date = new Date(item.date);
            const icon = item.type === 'achat' ? 'ðŸ›’' : item.type === 'vente' ? 'ðŸ’°' : 'ðŸ‘¥';
            const color = item.type === 'achat' ? '#2563eb' : item.type === 'vente' ? '#10b981' : '#8b5cf6';
            return `
              <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${color};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-size: 16px; margin-right: 8px;">${icon}</span>
                    <span style="font-size: 14px; font-weight: 500; color: #374151;">${item.fournisseur}</span>
                    <span style="font-size: 13px; color: #6b7280; margin-left: 8px;">${item.produit}</span>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 14px; font-weight: 600; color: ${color};">${item.montant_total.toFixed(2)} DH</div>
                    <div style="font-size: 12px; color: #9ca3af;">${date.toLocaleDateString('fr-FR')}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }
    }
    
    function updateAchatsList() {
      const tbody = document.getElementById('achats-tbody');
      if (!tbody) return;
      
      const achats = allData.filter(d => d.type === 'achat');
      
      if (achats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #9ca3af;">Aucun achat enregistrÃ©</td></tr>';
      } else {
        tbody.innerHTML = achats.map(achat => {
          const date = new Date(achat.date);
          return `
            <tr class="table-row" data-id="${achat.__backendId}">
              <td style="padding: 16px; font-size: 14px; color: #374151;">${date.toLocaleDateString('fr-FR')}</td>
              <td style="padding: 16px; font-size: 14px; color: #374151;">${achat.fournisseur}</td>
              <td style="padding: 16px; font-size: 14px; color: #374151;">${achat.produit}</td>
              <td style="padding: 16px; text-align: right; font-size: 14px; color: #374151;">${achat.quantite} kg</td>
              <td style="padding: 16px; text-align: right; font-size: 14px; color: #374151;">${achat.prix_unitaire.toFixed(2)} DH</td>
              <td style="padding: 16px; text-align: right; font-size: 14px; font-weight: 600; color: #2563eb;">${achat.montant_total.toFixed(2)} DH</td>
              <td style="padding: 16px; text-align: center;">
                <span style="padding: 4px 12px; background: #dcfce7; color: #15803d; border-radius: 12px; font-size: 12px; font-weight: 500;">${achat.statut}</span>
              </td>
              <td style="padding: 16px; text-align: center;">
                <button class="btn-delete" data-id="${achat.__backendId}" style="background: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer;">Supprimer</button>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const record = allData.find(r => r.__backendId === id);
            if (record && window.dataSdk) {
              if (!btn.dataset.confirming) {
                btn.textContent = 'Confirmer ?';
                btn.dataset.confirming = 'true';
                btn.style.background = '#dc2626';
                setTimeout(() => {
                  btn.textContent = 'Supprimer';
                  delete btn.dataset.confirming;
                  btn.style.background = '#ef4444';
                }, 3000);
              } else {
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0 auto;"></div>';
                const result = await window.dataSdk.delete(record);
                if (result.isOk) {
                  showToast("Achat supprimÃ©", "success");
                } else {
                  showToast("Erreur lors de la suppression", "error");
                  btn.disabled = false;
                  btn.textContent = 'Supprimer';
                }
              }
            }
          });
        });
      }
    }
    
    function updateVentesList() {
      const tbody = document.getElementById('ventes-tbody');
      if (!tbody) return;
      
      const ventes = allData.filter(d => d.type === 'vente');
      
      if (ventes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #9ca3af;">Aucune vente enregistrÃ©e</td></tr>';
      } else {
        tbody.innerHTML = ventes.map(vente => {
          const date = new Date(vente.date);
          return `
            <tr class="table-row" data-id="${vente.__backendId}">
              <td style="padding: 16px; font-size: 14px; color: #374151;">${date.toLocaleDateString('fr-FR')}</td>
              <td style="padding: 16px; font-size: 14px; color: #374151;">${vente.fournisseur}</td>
              <td style="padding: 16px; font-size: 14px; color: #374151;">${vente.produit}</td>
              <td style="padding: 16px; text-align: right; font-size: 14px; color: #374151;">${vente.quantite} L</td>
              <td style="padding: 16px; text-align: right; font-size: 14px; color: #374151;">${vente.prix_unitaire.toFixed(2)} DH</td>
              <td style="padding: 16px; text-align: right; font-size: 14px; font-weight: 600; color: #10b981;">${vente.montant_total.toFixed(2)} DH</td>
              <td style="padding: 16px; text-align: center;">
                <span style="padding: 4px 12px; background: #dcfce7; color: #15803d; border-radius: 12px; font-size: 12px; font-weight: 500;">${vente.statut}</span>
              </td>
              <td style="padding: 16px; text-align: center;">
                <button class="btn-delete" data-id="${vente.__backendId}" style="background: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer;">Supprimer</button>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const record = allData.find(r => r.__backendId === id);
            if (record && window.dataSdk) {
              if (!btn.dataset.confirming) {
                btn.textContent = 'Confirmer ?';
                btn.dataset.confirming = 'true';
                btn.style.background = '#dc2626';
                setTimeout(() => {
                  btn.textContent = 'Supprimer';
                  delete btn.dataset.confirming;
                  btn.style.background = '#ef4444';
                }, 3000);
              } else {
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0 auto;"></div>';
                const result = await window.dataSdk.delete(record);
                if (result.isOk) {
                  showToast("Vente supprimÃ©e", "success");
                } else {
                  showToast("Erreur lors de la suppression", "error");
                  btn.disabled = false;
                  btn.textContent = 'Supprimer';
                }
              }
            }
          });
        });
      }
    }
    
    function updateStock() {
      const achats = allData.filter(d => d.type === 'achat');
      const ventes = allData.filter(d => d.type === 'vente');
      
      const stockMatieres = achats.reduce((acc, a) => {
        if (!acc[a.produit]) acc[a.produit] = 0;
        acc[a.produit] += a.quantite;
        return acc;
      }, {});
      
      const stockExtraits = ventes.reduce((acc, v) => {
        if (!acc[v.produit]) acc[v.produit] = 0;
        acc[v.produit] += v.quantite;
        return acc;
      }, {});
      
      const stockMatieresDiv = document.getElementById('stock-matieres');
      const stockExtraitsDiv = document.getElementById('stock-extraits');
      
      if (stockMatieresDiv) {
        if (Object.keys(stockMatieres).length === 0) {
          stockMatieresDiv.innerHTML = '<div style="padding: 12px; background: #f9fafb; border-radius: 8px;"><div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; color: #374151;">Noix d\'argan</span><span style="font-size: 14px; font-weight: 600; color: #2563eb;">0 kg</span></div></div>';
        } else {
          stockMatieresDiv.innerHTML = Object.entries(stockMatieres).map(([produit, quantite]) => `
            <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px; color: #374151;">${produit}</span>
                <span style="font-size: 14px; font-weight: 600; color: #2563eb;">${quantite.toFixed(2)} kg</span>
              </div>
            </div>
          `).join('');
        }
      }
      
      if (stockExtraitsDiv) {
        if (Object.keys(stockExtraits).length === 0) {
          stockExtraitsDiv.innerHTML = '<div style="padding: 12px; background: #f9fafb; border-radius: 8px;"><div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; color: #374151;">Huile d\'argan</span><span style="font-size: 14px; font-weight: 600; color: #10b981;">0 L</span></div></div>';
        } else {
          stockExtraitsDiv.innerHTML = Object.entries(stockExtraits).map(([produit, quantite]) => `
            <div style="padding: 12px; background: #f9fafb; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px; color: #374151;">${produit}</span>
                <span style="font-size: 14px; font-weight: 600; color: #10b981;">${quantite.toFixed(2)} L</span>
              </div>
            </div>
          `).join('');
        }
      }
    }
    
    function updateFournisseurs() {
      const fournisseursGrid = document.getElementById('fournisseurs-grid');
      if (!fournisseursGrid) return;
      
      const fournisseurs = allData.filter(d => d.type === 'fournisseur');
      
      if (fournisseurs.length === 0) {
        fournisseursGrid.innerHTML = '<div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; color: #9ca3af;">Aucun fournisseur enregistrÃ©</div>';
      } else {
        fournisseursGrid.innerHTML = fournisseurs.map(f => `
          <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">${f.fournisseur}</h4>
            <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">${f.produit}</p>
            <p style="font-size: 13px; color: #9ca3af; margin-bottom: 16px;">${f.notes || 'Aucune note'}</p>
            <button class="btn-delete-fournisseur" data-id="${f.__backendId}" style="width: 100%; background: #ef4444; color: white; padding: 8px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer;">Supprimer</button>
          </div>
        `).join('');
        
        fournisseursGrid.querySelectorAll('.btn-delete-fournisseur').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const record = allData.find(r => r.__backendId === id);
            if (record && window.dataSdk) {
              if (!btn.dataset.confirming) {
                btn.textContent = 'Confirmer ?';
                btn.dataset.confirming = 'true';
                btn.style.background = '#dc2626';
                setTimeout(() => {
                  btn.textContent = 'Supprimer';
                  delete btn.dataset.confirming;
                  btn.style.background = '#ef4444';
                }, 3000);
              } else {
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0 auto;"></div>';
                const result = await window.dataSdk.delete(record);
                if (result.isOk) {
                  showToast("Fournisseur supprimÃ©", "success");
                } else {
                  showToast("Erreur lors de la suppression", "error");
                  btn.disabled = false;
                  btn.textContent = 'Supprimer';
                }
              }
            }
          });
        });
      }
    }
    
    function updateRapports() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      const thisMonthData = allData.filter(d => {
        const date = new Date(d.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
      });
      
      const achats = thisMonthData.filter(d => d.type === 'achat');
      const ventes = thisMonthData.filter(d => d.type === 'vente');
      
      const totalAchats = achats.reduce((sum, a) => sum + (a.montant_total || 0), 0);
      const totalVentes = ventes.reduce((sum, v) => sum + (v.montant_total || 0), 0);
      const marge = totalVentes - totalAchats;
      
      const rapportMensuel = document.getElementById('rapport-mensuel');
      if (rapportMensuel) {
        rapportMensuel.innerHTML = `
          <div style="padding: 16px; background: #eff6ff; border-radius: 8px;">
            <div style="font-size: 13px; color: #1e40af; margin-bottom: 4px;">Achats du mois</div>
            <div style="font-size: 24px; font-weight: 700; color: #2563eb;">${totalAchats.toFixed(2)} DH</div>
          </div>
          <div style="padding: 16px; background: #f0fdf4; border-radius: 8px;">
            <div style="font-size: 13px; color: #15803d; margin-bottom: 4px;">Ventes du mois</div>
            <div style="font-size: 24px; font-weight: 700; color: #10b981;">${totalVentes.toFixed(2)} DH</div>
          </div>
          <div style="padding: 16px; background: #faf5ff; border-radius: 8px;">
            <div style="font-size: 13px; color: #6b21a8; margin-bottom: 4px;">Marge du mois</div>
            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">${marge.toFixed(2)} DH</div>
          </div>
        `;
      }
      
      const rapportHistorique = document.getElementById('rapport-historique');
      if (rapportHistorique) {
        if (allData.length === 0) {
          rapportHistorique.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Aucune transaction Ã  afficher</div>';
        } else {
          const sorted = [...allData].sort((a, b) => new Date(b.date) - new Date(a.date));
          rapportHistorique.innerHTML = sorted.map(item => {
            const date = new Date(item.date);
            const icon = item.type === 'achat' ? 'ðŸ›’' : item.type === 'vente' ? 'ðŸ’°' : 'ðŸ‘¥';
            const color = item.type === 'achat' ? '#2563eb' : item.type === 'vente' ? '#10b981' : '#8b5cf6';
            const typeLabel = item.type === 'achat' ? 'Achat' : item.type === 'vente' ? 'Vente' : 'Fournisseur';
            return `
              <div style="padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${color};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-size: 16px; margin-right: 8px;">${icon}</span>
                    <span style="font-size: 13px; font-weight: 600; color: ${color}; margin-right: 8px;">${typeLabel}</span>
                    <span style="font-size: 14px; font-weight: 500; color: #374151;">${item.fournisseur}</span>
                    <span style="font-size: 13px; color: #6b7280; margin-left: 8px;">${item.produit}</span>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 14px; font-weight: 600; color: ${color};">${item.montant_total ? item.montant_total.toFixed(2) + ' DH' : '-'}</div>
                    <div style="font-size: 12px; color: #9ca3af;">${date.toLocaleDateString('fr-FR')}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }
    }
    
    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toast.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
      toast.style.color = 'white';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ad38d5f619cbce',t:'MTc2MjUyMjYxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>